# -----------------------------------------------------------
#
# apache include log content
#
# -----------------------------------------------------------
read -d '' TEMPLATE_DISCLAIMER <<EndOfMessage
# ----------------------------------------------------------------------------
# This file is automatically generated by the apache-virtual-host-manager
# script. All changes will be overwritten with the next build process.
# Do not make any changes to this file.
#
# date of creation: %s
# produced by:      apache-virtual-host-manager
#                   https://github.com/bjoern-hempel/apache-virtual-host-manager
# ----------------------------------------------------------------------------

EndOfMessage


# -----------------------------------------------------------
#
# apache include log content
#
# -----------------------------------------------------------
read -d '' TEMPLATE_APACHE_INCLUDES_LOG <<EndOfMessage
%s

ErrorLog  \${APACHE_LOG_DIR}/error.log
LogLevel  warn
CustomLog \${APACHE_LOG_DIR}/access.log combined
EndOfMessage


# -----------------------------------------------------------
#
# apache include general content
#
# -----------------------------------------------------------
read -d '' TEMPLATE_APACHE_INCLUDES_GENERAL <<EndOfMessage
%s

#
# Generell settings
#
ServerAdmin bjoern@hempel.li
ServerName  %s%s

#
# redirect /.well-known/acme-challenge to local letsencrypt folder
#
Alias /.well-known/acme-challenge /var/www/dehydrated
<Directory /var/www/dehydrated/.acme-challenges>
    Options None
    AllowOverride None
    Require all granted
</Directory>%s%s

#
# redirect all other pages to host and port %s
#
ProxyPreserveHost On
ProxyPassMatch ^/.well-known !
ProxyPass / http://172.17.0.1:%s/ disablereuse=On retry=0
ProxyPassReverse / http://172.17.0.1:%s/

#
# password protection
#
<Location />
    SetEnvIf Request_URI ".well-known" no-authentication

    # no authentication: post do not require an authentication
    SetEnvIf Request_Method "OPTIONS"                                              no-authentication

    <If "-f '%s'">
        <RequireAny>
            <RequireAll>
                Require all granted
                Require env no-authentication
            </RequireAll>
            <RequireAll>
                AuthType     Basic
                AuthName     "2016"
                AuthUserFile %s
                Require      valid-user
            </RequireAll>
        </RequireAny>
    </If>
</Location>
EndOfMessage


# -----------------------------------------------------------
#
# apache https redirect
#
# -----------------------------------------------------------
read -d '' TEMPLATE_APACHE_INCLUDES_GENERAL_SSL_REDIRECT <<EndOfMessage
#
# redirect http to https
#
<IfModule mod_rewrite.c>
    RewriteEngine on
    RewriteCond %%{SERVER_PORT} !^443\$
    RewriteCond %%{REQUEST_URI} !^/.well-known
    RewriteRule ^/(.*) https://%%{HTTP_HOST}/\$1 [NC,R=301,L,NE]
</IfModule>
EndOfMessage


# -----------------------------------------------------------
#
# apache alias redirect
#
# -----------------------------------------------------------
read -d '' TEMPLATE_APACHE_INCLUDES_GENERAL_ALIAS_REDIRECT <<EndOfMessage
#
# redirect alias %s to %s
#
<IfModule mod_rewrite.c>
    RewriteEngine on
    RewriteCond %%{HTTP_HOST} ^%s$ [NC]
    RewriteCond %%{REQUEST_URI} !^/.well-known
    RewriteRule ^(.*)$ https://%s%%{REQUEST_URI} [R=301,L]
</IfModule>
EndOfMessage


# -----------------------------------------------------------
#
# apache server alias
#
# -----------------------------------------------------------
TEMPLATE_APACHE_INCLUDES_GENERAL_ALIAS="ServerAlias %s"


# -----------------------------------------------------------
#
# apache include ssl content
#
# -----------------------------------------------------------
read -d '' TEMPLATE_APACHE_INCLUDES_SSL <<EndOfMessage
%s

#
# SSL settings
#
SSLEngine               on
SSLCertificateFile      /etc/dehydrated/certs/%s/fullchain.pem
SSLCertificateKeyFile   /etc/dehydrated/certs/%s/privkey.pem
EndOfMessage

# -----------------------------------------------------------
#
# apache sites-available http content
#
# -----------------------------------------------------------
read -d '' TEMPLATE_APACHE_SITES_AVAILABLE_HTTP <<EndOfMessage
#
# %s
# 
<VirtualHost *:80>
    RequestHeader set X-Forwarded-Proto "http"

    include includes/%s.general
    include includes/log
</VirtualHost>
EndOfMessage


# -----------------------------------------------------------
#
# apache sites-available https content
#
# -----------------------------------------------------------
read -d '' TEMPLATE_APACHE_SITES_AVAILABLE_HTTPS <<EndOfMessage
#
# %s
#
<VirtualHost *:443>
    include includes/%s.general
    include includes/log
    include includes/%s.ssl
</VirtualHost>
EndOfMessage

